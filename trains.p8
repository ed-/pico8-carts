pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- trains
-- slumberheart + camera
--[[

truchet tron with trains

- toggle individual tiles
- your train and theirs run
- the tracks
- try not to die
- toggle between cross/switch
  or just rotate 
  
- turn based or cooldown based
- maybe random +length powerups

- crashes can happen at cross intersections
- cannot change a tile if it was just changed
- cannot change a tile if there are any trains on it

--]]

function _init()
  cls()
  _mode = 0
  _frame = 0
  _game = game:new{}
  _game:new_game()
end

function _update()
  _frame = (_frame + 1) % 30
  if _mode == 0 then
    _game:update()
  else
  end
end

function _draw()
  cls()
  if _mode == 0 then
    _game:draw()
  else
  end
end

class = {}
function class:new(z)
  z = z or {}
  setmetatable(z, self)
  self.__index = self
  return z
end

-->8
-- game
game = class:new{
  actors = {},
  board = {},
  cursors = {},
}

function game:new_game()
  self.actors = {}
  
  self.cursors = {}  
  add(self.cursors, pcursor:new{player=0, pcolor=8})
  
  self.board = board:new{}
  self.board:new_board()

end

function game:update()
  self.board:update()
  for actor in all(self.actors) do
    actor:update()
  end
  for c in all(self.cursors) do
    c:update()
  end
end

function game:draw()
  self.board:draw()
  for actor in all(self.actors) do
    actor:draw()
  end
  for c in all(self.cursors) do
    c:draw()
  end
end

-->8
-- pcursor
pcursor = class:new{
  player = 0,
  pcolor = 7,
  r = 0,
  c = 0,
  x = 0,
  y = 0,
}

function pcursor:update()
  if btnp(0, self.player) then
    self:left()
  end
  if btnp(1, self.player) then
    self:right()
  end
  if btnp(2, self.player) then
    self:up()
  end
  if btnp(3, self.player) then
    self:down()
  end
  if btnp(4, self.player) then
    self:switch()
  end
  if btnp(5, self.player) then
    self:rotate()
  end
  self.x = (self.c * 16) + 4
  self.y = (self.r * 16) + 4
end

function pcursor:draw()
  pal(15, self.pcolor)
  spr(1, self.x, self.y)
  pal()
end

function pcursor:left()
  if (self.c > 0) then
    self.c -= 1
  end
end

function pcursor:right()
  if (self.c < 7) then
    self.c += 1
  end
end

function pcursor:up()
  if (self.r > 0) then
    self.r -= 1
  end
end

function pcursor:down()
  if (self.r < 7) then
    self.r += 1
  end
end

function pcursor:rotate()
  _game.board:rotate(self.r, self.c, self.pcolor)
end

function pcursor:switch()
  _game.board:switch(self.r, self.c, self.pcolor)
end
-->8
-- board
board = class:new{
  tiles = {}
}

function board:new_board()
  self.tiles = {}
  for r=0,7 do
    for c=0,7 do
      local z = ((r + c) % 2) + 1
      add(self.tiles, tile:new{r=r, c=c, face=z})
    end
  end
end

function board:update()
  for t in all(self.tiles) do
    t:update()
  end
end

function board:draw()
  for t in all(self.tiles) do
    t:draw()
  end
end

function board:rotate(r, c, pcolor)
  for t in all(self.tiles) do
    if t.r == r and t.c == c then
      t:rotate(pcolor)
    end
  end
end

function board:switch(r, c, pcolor)
  for t in all(self.tiles) do
    if t.r == r and t.c == c then
      t:switch(pcolor)
    end
  end
end
-->8
--tile
tile = class:new{
  r = 0,
  c = 0,
  x = 0,
  y = 0,
  face = 0,
  pcolor = 0,
}

function tile:update()
  self.x = self.c * 16
  self.y = self.r * 16
end

function tile:draw()
  local faces = {32, 34, 36, 38}
  pal(15, self.pcolor)
  spr(faces[self.face], self.x, self.y, 2, 2)
  pal()
end  

function tile:rotate(pcolor)
  if self.pcolor != 0 then
    return
  end
  local z = {2, 1, 4, 3}
  self.face = z[self.face]
  self.pcolor = pcolor
end

function tile:switch(pcolor)
  if self.pcolor != 0 then
    return
  end
  local z = {3, 4, 1, 2}
  self.face = z[self.face]
  self.pcolor = pcolor
end

function tile:uncolor()
  self.pcolor = 0
end
__gfx__
00000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000f00f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000f000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700f0000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000f00ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000fff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000055550000000000005555000000000000555500000000000055550000000000000000000000000000000000000000000000000000000000000000000000
00000055550000000000005555000000000000555500000000000055550000000000000000000000000000000000000000000000000000000000000000000000
00fff055550fff0000fff055550fff0000fff055550fff0000fff055550fff000000000000000000000000000000000000000000000000000000000000000000
00f0005555000f0000f0005555000f0000f0055550000f0000f0000555500f000000000000000000000000000000000000000000000000000000000000000000
00f0005555000f0000f0005555000f0000f0055550000f0000f0000555500f000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000005555000000000555550000000000000000555550000000000000000000000000000000000000000000000000000000000000000000
55555555555555555555505555055555555555550000055555500000555555550000000000000000000000000000000000000000000000000000000000000000
55555555555555555555505555055555555555500005555555555000055555550000000000000000000000000000000000000000000000000000000000000000
55555555555555555555505555055555555550000555555555555550000555550000000000000000000000000000000000000000000000000000000000000000
55555555555555555555505555055555555000005555555555555555000005550000000000000000000000000000000000000000000000000000000000000000
00000000000000000000005555000000000000005555500000055555000000000000000000000000000000000000000000000000000000000000000000000000
00f0005555000f0000f0005555000f0000f0000555500f0000f0055550000f000000000000000000000000000000000000000000000000000000000000000000
00f0005555000f0000f0005555000f0000f0000555500f0000f0055550000f000000000000000000000000000000000000000000000000000000000000000000
00fff055550fff0000fff055550fff0000fff055550fff0000fff055550fff000000000000000000000000000000000000000000000000000000000000000000
00000055550000000000005555000000000000555500000000000055550000000000000000000000000000000000000000000000000000000000000000000000
00000055550000000000005555000000000000555500000000000055550000000000000000000000000000000000000000000000000000000000000000000000
