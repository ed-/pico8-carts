pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- skeletonwar
-- slumberheart

--[[

if your grave doesnt say "rest
in peace" on it you are
automatically drafted into the
skeleton war

- @dril

]]

function _init()
  cls()
  _mode = 0
  _frame = 0
  _game = game:new()
  _game:reset()
end

function _update()
  _frame = (_frame + 1) % 30
  if _mode == 0 then
    _game:update()
  else
  end
end

function _draw()
  cls()
  if _mode == 0 then
    draw(game)
  else
  end
end

function update(something)
  something:update()
end

function draw(something)
  something:draw()
end
-->8
-- game
game = {
  actors = {},
}

function game:new(z)
  z = z or {}
  setmetatable(z, self)
  self.__index = self
  return z
end

function game:reset()
  add(self.actors, warrior:new{})
  for i=1,10 do
    add(self.actors, skeleton:new{
      x=flr(rnd(120)),
      y=flr(rnd(120)),})
  end
end
 
function game:update()
  foreach(self.actors, update)
end

function game:draw()
  foreach(self.actors, draw)
end
-->8
--actor
actor = {
  dx = 0,
  dy = 0,
  maxd = 1,
  x = 0,
  y = 0,
  sprites = {0},
  facingleft = false,
  faction = nil,
  clock = 0,
}

function actor:new(z)
  z = z or {}
  setmetatable(z, self)
  self.__index = self
  return z
end

function actor:update()
  if _frame % 15 == 0 then
    self.clock = (self.clock + 1) % 4
  end
  local lr = flr(rnd(3)) - 1
  local ud = flr(rnd(3)) - 1
  self:stand()
  if lr < 0 then
    self:left()
  elseif lr > 0 then
    self:right()
  end
  if ud < 0 then
    self:up()
  elseif ud > 0 then
    self:down()
  end
  self:move()
end

function actor:move()
  if self.dx > self.maxd then
    self.dx = self.maxd
  end
  if self.dx < 0 - self.maxd then
    self.dx = 0 - self.maxd
  end
  self.x += self.dx
  if self.x >= 120 then
    self.x = 120
  end
  if self.x < 0 then
    self.x = 0
  end

  if self.dy > self.maxd then
    self.dy = self.maxd
  end
  if self.dy < 0 - self.maxd then
    self.dy = 0 - self.maxd
  end 
  self.y += self.dy
  if self.y >= 120 then
    self.y = 120
  end
  if self.y < 0 then
    self.y = 0
  end
end

function actor:left()
  self.dx = 0 - self.maxd
  self.facingleft = true
end

function actor:right()
  self.dx = self.maxd
  self.facingleft = false
end

function actor:up()
  self.dy = 0 - self.maxd
end

function actor:down()
  self.dy = self.maxd
end

function actor:stand()
  self.dx = 0
  self.dy = 0
end

function actor:draw()
  local sprite = self.sprites[self.clock + 1]
  spr(sprite, self.x, self.y, 1, 1, self.facingleft)
end
-->8
-- warrior
warrior = actor:new{
  faction="player",
  sprite=1,
  maxd=4,
}

function warrior:update()
  local do_decay = true
  if btn(0) then
    self:left()
    do_decay = false
  end
  if btn(1) then
    self:right()
    do_decay = false
  end
  if btn(2) then
    self:up()
    do_decay = false
  end
  if btn(3) then
    self:down()
    do_decay = false
  end
  if do_decay then
    if self.dx < 0 then
      self.dx += 1
    elseif self.dx > 0 then
      self.dx -= 1
    end
    if self.dy < 0 then
      self.dy += 1
    elseif self.dy > 0 then
      self.dy -= 1
    end
  end
  self:move()
end

function warrior:left()
  self.dx -= 1
  self.facingleft = true
end

function warrior:right()
  self.dx += 1
  self.facingleft = false
end

function warrior:up()
  self.dy -= 1
end

function warrior:down()
  self.dy += 1
end
    
function warrior:move()
  self.lastx = self.x
  self.lasty = self.y
  actor.move(self)
end

--[[
function warrior:draw()
  spr(2, self.lastx, self.lasty, 1, 1, self.facingleft)
  actor.draw(self)
end
]]
-->8
--skeleton
skeleton = actor:new{
  sprites={34, 34, 34, 34},
  faction="skeleton",
}
__gfx__
00000000006600000066000000110000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000066660000666606001111000011110100000000000000000000000000000000000000000000000000056650000000000000000000000000000000000
00700700050600600506006001010010010100100000000000000000000000000000000000000000000000000007700000000000000000000000000000000000
0007700005fff06005fff07001111010011110100000000000000000000000000000000000000000000000000002200000000000000000000000000000000000
00077000f4114070541145f51111101011111111000000000000000000000000000000000000000000000000002e980000000000000000000000000000000000
00700700511615f5f1161050111111111111101000000000000000000000000000000000000000000000000002e9888000000000000000000000000000000000
00000000044440500444400001111010011110000000000000000000000000000000000000000000000000000088880000000000000000000000000000000000
00000000050050000500500001001000010010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3bbb00401ccc0000006600008888000022220000006600000066000000ff004010cc010000a0a000009900000000000000000000000000000000000000000000
0b3330040c11109006666060082220000288800006666000066660000ffff0401cccc1000aaaa000094440600000000000000000000000000000000000000000
030f0004010f004005060060020f0000080f000006060000060600000f0f00400c0c0000050f0000040f00660000000000000000000000000000000000000000
0ffff0040ffff04005fff07009fff0000ffff0000fffcccc0ffff0000ffff0400ffff00005fff0000ffff0060000000000000000000000000000000000000000
3bbbb3f41c66c1f0541145f588888800222222008888cc6c888888f099ff99f052222500222222005555557f0000000000000000000000000000000000000000
f5565004fccac040f1161050f44a48f0f11518f0f119c6c6f1191800f9999040fccccf00f77c76f0f76d67000000000000000000000000000000000000000000
0bbbb0040cccc0400444400008888000288882008666cccc866668000888804001cc105026666200566665000000000000000000000000000000000000000000
04004040c5cc504005005000858858002400420084004cc084004800040040400500500625225200550055000000000000000000000000000000000000000000
00660040006600000066000000660000006600000066000000660000006600404066040000a0a000006600000000000000000000000000000000000000000000
0677700406777040067770600677700006777000067770000677700006777040467774000aaaa000067770600000000000000000000000000000000000000000
06878004068780400687806006878000068780000687800006878000068780400687800006878000068780660000000000000000000000000000000000000000
00777004007770400077706000777000007770000077222200777000007770400077700000777000007770060000000000000000000000000000000000000000
3bbbb3741cccc17065665670cccccc0022222200444422d24444447099dd997052222500111111005555557d0000000000000000000000000000000000000000
7dd6d0047ccac0407ddad0607dd6dc70711d147071192d2d71191400799990407cccc700677c7660d76d67000000000000000000000000000000000000000000
0bbbb0040cccc040055550000cccc0002444420046662222466664000444404001cc105046666400566665000000000000000000000000000000000000000000
05005040c5cc504006006000c5cc5c00250052004500522045005400050050400500500645445400550055000000000000000000000000000000000000000000
000000000000330004000000000000000000000000000000a094090000000000a094090000000000000000000000000000000000000000000000000000000000
000000000003abb00440bb0000000000000000000066660094666640006666009466664000000000000000000000000000000000000000000000000000000000
00000000003bbb80444bbbb000000000000000000667776046677760066777604667776000000000000000000000000000000000000000000000000000000000
00011000003bb008445b4b4000000000000000000677777606777776067787760677977600000000000000000000000000000000000000000000000000000000
001dd100003b000044c5bbb000000000000000000067878604679796006777760467777600000000000000000000000000000000000000000000000000000000
01dccd10000b0000040555c000022020000000000006767000967670000676700096767000000000000000000000000000000000000000000000000000000000
0dc8c8d03003b00004030300002222c2000ff0000000606000006060000060600000606000000000000000000000000000000000000000000000000000000000
dccccccd033b00000000000042f22f000ff00f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
